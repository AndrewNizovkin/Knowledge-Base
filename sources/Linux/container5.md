# Docker Compose и Docker Swarm

[Методичка](https://gbcdn.mrgcdn.ru/uploads/asset/4925076/attachment/e02a9ebaf3a83815e8bd7b6aacd4500d.pdf)

- ДК позволяет управлять несколькими контейнерами из одного yml-файла.

YAML — это язык для сериализации данных, который отличается простым
синтаксисом и позволяет хранить сложноорганизованные данные в компактном и читаемом формате. 

YAML — это язык для хранения информации в формате, понятном человеку. Его название расшифровывается как, «Ещё один язык разметки». Однако, позже расшифровку изменили на — «YAML не язык разметки», чтобы отличать его от настоящих языков разметки.

Язык похож на XML и JSON, но использует более минималистичный синтаксис при сохранении аналогичных возможностей. YAML обычно применяют для создания конфигурационных файлов в программах типа Инфраструктура как код (Iac), или для управления контейнерами в работе DevOps.

Особенности YAML:
● понятный человеку код;
● минималистичный синтаксис;
● заточен под работу с данными;
● встроенный стиль, похожий на JSON (YAML является его надмножеством);
● поддерживает комментарии;
● поддерживает строки без кавычек;
● считается «чище», чем JSON;
● дополнительные возможности (расширяемые типы данных, относительные якоря и маппинг типов с сохранением порядка ключей).

Пример:

```bash
version: '3.9'

services:

  db:
    image: mariadb:10.10.2
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: 12345

  adminer:
    image: adminer:4.8.1
    restart: always
    ports:
      - 6080:8080
```

В целом, манифест довольно прост. Давайте перейдем к комментариям и
описанию:
● version: ‘3.9’ - в этой строке описывается версия compose-файла. Каждый  файл обязательно должен начинаться с тега версии. Глобально версий всего три. Первая, которая более не поддерживается, вторая и третья. Каждой версии файла соответствует определенная версия докера, установленная на машине. Например, для версии 3.1 необходимо, чтобы установленный докер был не ниже версии 1.13.1, а вот версия 3.8 уже требует минимум версию 19.03.0.
● services: - эта строка говорит о том, что далее в файле будут описаны сервисы (один или несколько), которые необходимо запустить или остановить (зависит от команды, передаваемой в докер). Важно помнить, что ДК работает с сервисами (1 сервис = 1 контейнер). Сервисом при этом может быть клиент, сервер, сервер БД и так далее.
● db: - это название первого сервиса. Название каждый может придумать какое угодно вам. Понятное название сервиса поможет определить его роль и сделать манифесты более читаемыми.
● build: ./db - ключевое слово, позволяющее задать путь к файлу `Dockerfile`, который будет использован для создания собственного образа и который, в свою очередь, позволит запустить сервис.
● image: mariadb - если вместо build указан этот вариант, система будет использовать готовые образы с docker hub. 
● restart: always - позволяет определить политику перезапуска контейнера. Существует несколько вариантов:

○ no - не перезапускать контейнер автоматически. Это значение по умолчанию. Если мы ничего не укажем, контейнер не будет перезапускаться
○ on-failure [max retries] - перезапускать контейнер, если он был завершен не с нулевым кодом выхода. В данном случае необходимо указать максимальное количество попыток перезапуска
○ always - всегда перезапускать контейнер, если он был остановлен.
Здесь стоит быть аккуратнее в связи с тем, что в этом случае возможен цикличный перезапуск контейнера с проблемами
○ unless-stopped - всегда перезапускать контейнер. По сути, этот вариант аналогичен always кроме случаев, когда он был остановлен вручную.
При этом он не перезапускается после перезапуска демона докера.

-  environment - в этом блоке прописываются переменные, которые могут
быть использованы для работы контейнера

- ports - указывает на то, какие порты необходимо открыть для связи с
контейнером

Оркестрация контейнеров — это централизованное и эффективное управление, а также мониторинг контейнеров. И важное замечание: не только самих контейнеров, но и их окружения, включая их отношения и связи друг с другом.

Инструмент оркестрации должен иметь как минимум 3 ключевых элемента:
● Развертывание
● Масштабирование
● Надежность

Развертывание - это возможность эффективно деплоить наши контейнеры в соответствии с заданными параметрами. Оно обычно осуществляется с помощью манифестов. Манифест — это файл JSON, содержащий всю информацию о контейнерах Docker, которые необходимо развернуть.

Масштабирование - возможность увеличения количества запущенных контейнеров простым способом. Например, если у нас есть контейнер, в котором работает веб-сервер (или БД), и трафик растет, мы можем масштабировать его и дублировать один и тот же контейнер столько раз, сколько необходимо для удовлетворения всех входящих запросов. Масштабирование работает не только в сторону роста, количество реплик контейнера также может быть уменьшено, если, например, уменьшится трафик.

Надёжность. Помимо всего прочего, оркестратор должен быть способен поддерживать работоспособность нашего приложения. Что здесь имеется ввиду: как только мы объявим контейнеры, которые необходимо развернуть для нашего приложения, оркестратор должен позаботиться о том, чтобы были развернуты они и вся инфраструктура, которая необходима. Учитывая, что в зависимости от нагрузки контейнеры могут быть развернуты дополнительно либо удалены (лишние имеется в виду), оркестратор также должен быть способен выполнять эти задачи автоматически: поднимать дополнительные контейнеры, останавливать избыточные, чтобы экономить ресурсы.

## Основные команды ДК

Прежде чем мы окончательно перейдем к практике, предлагаю рассмотреть набор доступных команд. Он невелик и достаточно прост:

● docker-compose build - команда позволяет собрать сервисы, описанные в конфигурационных файлах 

● docker-compose up -d - запускает наш проект. В данном случае проект запустится в фоновом режиме, так как в команде присутствует флаг -d

● docker-compose start - запускает любые остановленные ранее сервисы в соответствии с указанными параметрами

● docker-compose down - останавливает наш проект и, что немаловажно, удаляет все сервисы, которые были запущены ранее

● docker-compose stop - эта команда просто останавливает все сервисы, описанные в конфигурации. Она не удаляет контейнеры, тома, сети и прочие сущности, описанные в конфигурационном файле

● docker-compose logs -f [service name] - с помощью этой команды можно посмотреть логи нашего сервиса 

● docker-compose ps - выводит на экран список всех доступных контейнеров

● docker-compose exec [service name] [command] - с ее помощью можно выполнить команду в сервисе, не заходя при этом в контейнер. Ранее мы рассматривали подобное на уроке “Введение в Docker”

● docker-compose images - позволяет вывести список образов.

Третье - оба этих контейнера должны общаться друг с другом. Это также значит, что они формально имеют какую-либо общую сетевую инфраструктуру. Это может показаться сложным, однако, сейчас давайте поверим на слово, что инфраструктура (то бишь сеть) у них общая. Оба контейнера получили свои IP-адреса. Этот момент давайте проверим на всякий случай. Для этого запустим замечательную команду:

```bash
docker container inspect adminer
docker container inspect mariadb
```

## Docker Swarm

Итак, деплой приложения, состоящего из нескольких контейнеров мы освоили. Теперь давайте добавим к этому отказоустойчивость! Давайте научим наш докер работать не на одном сервере (ноде), а на трех, что принесет несколько плюсов:

1. Отказоустойчивость - при выходе из строя одной ноды из трех наши
контейнеры смогут продолжать работу на остальных узлах кластера.
2. Увеличение ресурсов - в случае работы в кластере, существенно
увеличивается мощность, доступная контейнерам для работы.

Node (нода) - это наш сервер с установленным на нем Docker. По сути, нодой могут быть как физические сервера, так и виртуальные машины. На лекционных и семинарских занятиях в качестве нод мы и будем использовать виртуальные машины - их мощностей более чем достаточно для наших примеров.
Stack - это набор сервисов, которые могут быть связаны между собой
логически. Иными словами, это набор сервисов, которые описываются в обычном compose файле. Важно заметить, что части стека могут располагаться как на одной ноде, так и на различных.

Сервис - это составляющая стека. Сервис является описанием того, какие
контейнеры необходимо создать. Ранее мы уже рассмотрели ДК файлы и, по сути, на практике познакомились с этой сущностью.
Task (задача) - непосредственно созданный контейнер, который движок
докера создает на основе предоставленной информации.

ДС - это стандартный оркестратор для контейнеров, который изначально
встроен в механизм работы докера. Он отлично подойдет для развертывания приложений в рабочей среде кластера. Его несомненный плюс - не нужно будет переписывать наши ДК файлы, а просто применять их для работы с ДС.
Также нужно заметить, что у ДС есть два типа нод (узлов):
● manager node - управляющий сервер. Он способен управлять нашим
кластером: добавлять и удалять сущности (например, ноды кластера). На нем также возможно запускать и контейнеры.
● worker node - на этом узле возможен лишь запуск контейнеров. Управление кластера с данного типа узлов недоступен.

Теперь давайте инициализируем наш кластер:

```bash
docker swarm init
```

В ответ на это мы получили следующую команду:

```bash
docker swarm join --token SWMTKN-1-3un77cn4m5ok3ijrdouwg3mit69uwmfwx96krc7taua7ovpjha-97y4z
k9ppc8hxk2caxlig23xo 192.168.50.90:2377

```

Это команда, с помощью которой мы сможем присоединить другие узлы
нашего будущего кластера. По сути, ввести их в кластер. На всех этих узлах необходимо ее выполнить.

```bash
# Проверка состояния кластера
docker node ls
# вывод:
ID HOSTNAME STATUS
AVAILABILITY MANAGER STATUS ENGINE VERSION
u6v4f0i3n88d4ab71m3nlolw8 * docker-1 Ready Active
Leader 20.10.21
zjgj80mu5gk1sjlclfx41dwxh docker-2 Ready Active
20.10.21
xeh4kycewpk780ytv6zjqvl06 docker-3 Ready Active
20.10.21

# Удаление ноды
docker node rm (ID ноды)
```

Итак, как мы видим, в кластере отображается ID каждой ноды, ее hostname и еще ряд информации: доступна ли она в настоящий момент времени и в каком статусе преобладает, готова ли она к запуску контейнеров или нет. Также, в самой правой колонке отображается информация о типе ноды manager или work нода в кластере.

Далее, что же можно еще сделать с нашими нодами? Давайте введем
следующую команду и посмотрим на предложения:

```bash
You might be seeing this error because you're using the wrong Compose file version. Either specify a supported version (e.g "2.2" or "3.3") and place your service definitions under the `services` key, or omit the `version` key and place your service definitions at the root of the file to use version 1.
For more on the Compose file format versions, see https://docs.docker.com/compose/compose-file/docker node --help
Usage: docker node COMMAND
Manage Swarm nodes
Commands:
demote Demote one or more nodes from manager in the swarm
inspect Display detailed information on one or more nodes
ls List nodes in the swarm
promote Promote one or more nodes to manager in the swarm
ps List tasks running on one or more nodes, defaults to current node
rm Remove one or more nodes from the swarm
update Update a node
```

## Docker Swarm и Overlay сети

Overlay-сети используются в кластерах ДС, где виртуальная сеть, используемая контейнерами, связывает несколько физических хостов, на которых запущен Docker. В случае, когда мы запускаем контейнер на swarm-кластере (как часть сервиса), множество сетей присоединяется по умолчанию, и каждая из них соответствует разным требованиям связи.

Существует несколько типов этих сетей:

● Overlay - создает простую подсеть, которая может быть использована
контейнерами на разных хостах swarm-кластера. В этом случае контейнеры, которые располагаются на разных физических хостах будут обмениваться именно через overlay сеть. Важное условие - каждый компонент должен иметь доступ к такой сети. Технически при выборе данной сети, мы получаем дополнительный слой 

● ingress - этот тип сети используется в ДС по умолчанию при создании
кластера. Она отвечает за связи, которые устанавливаются между
контейнерами (то есть сущностями внутри кластера и внешним миром).
Посредством этой сети происходит балансировка нагрузки, которую по
умолчанию и предоставляет ДС кластер.
● vxlan - при использовании этого типа сетей, у нас не просто происходит
создание Overlay-сети. В этом случае происходит инкапсуляция пакетов 2
слоя модели OSI в четвертый. С помощью этого действия докер и создает
этот тип сети. Любые конечные точки, содержащие этот тип сети, видят друг друга так, будто они подключены друг к другу посредством одного свитча. Эта сеть является технологией сетевой виртуализации, созданной для решения проблем масштабируемости в больших системах облачных
вычислений. 

● docker_gwbridge - эта сеть создается на каждом узле кластера. Она позволяет соединить трафик из контейнеров, находящихся внутри ДС кластера с внешним миром. Например, в случае, если мы из контейнера запустим команду ping [ya.ru](http://ya.ru/), будет использована эта сеть.

```bash
# Просмотр имеющихся сетей
docker network ls

# Создание сети
docker network create --driver overlay --subnet 4.5.6.0/24
test-network --attachable

# Запуск контейнера и подключение к сети
docker run -d --ip 4.5.6.7 --net test-network --name
container-1 busybox sleep 3600
```